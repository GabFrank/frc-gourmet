<div class="pdv-container">
    <!-- Left side panel -->
    <div class="left-panel">
        <!-- Total section -->
        <div class="total-section">
            <h2>Total</h2>
            <!-- Loading Indicator for Currency Configuration -->
            <div class="loading-currencies" *ngIf="loadingCurrencies">
                <div class="spinner-container">
                    <mat-spinner diameter="30"></mat-spinner>
                    <span>Cargando monedas...</span>
                </div>
            </div>

            <!-- Currency Totals -->
            <div class="currency-totals" *ngIf="!loadingConfig && !loadingExchangeRates">
                <div class="currency-item" *ngFor="let moneda of filteredMonedas">
                    <!-- Dynamic flag loading with fallback to base64 data -->
                    <img *ngIf="moneda.flagIconBase64" [src]="moneda.flagIconBase64" [alt]="moneda.denominacion"
                        class="currency-flag" />
                    <img *ngIf="!moneda.flagIconBase64 && moneda.flagIcon" [src]="moneda.flagIcon"
                        [alt]="moneda.denominacion" class="currency-flag" />
                    <img *ngIf="!moneda.flagIconBase64 && !moneda.flagIcon && moneda.countryCode" [src]="
              'https://flagcdn.com/w320/' +
              moneda.countryCode.toLowerCase() +
              '.png'
            " [alt]="moneda.denominacion" class="currency-flag" />
                    <img *ngIf="
              !moneda.flagIconBase64 && !moneda.flagIcon && !moneda.countryCode
            " src="assets/images/currency-placeholder.png" [alt]="moneda.denominacion" class="currency-flag" />

                    <!-- Currency value calculated from exchange rates -->
                    <span class="currency-value">{{
                        currencyTotals.get(moneda.id!) ?? 0
                        | number : "1.0-2"
                        }}</span>
                </div>
            </div>
            <h2>Saldo</h2>
            <!-- Loading Indicator for Currency Configuration -->
            <div class="loading-currencies" *ngIf="loadingCurrencies">
                <div class="spinner-container">
                    <mat-spinner diameter="30"></mat-spinner>
                    <span>Cargando monedas...</span>
                </div>
            </div>

            <!-- Currency Balances -->
            <div class="currency-totals">
                <div class="currency-item" *ngFor="let moneda of filteredMonedas">
                    <!-- Dynamic flag loading with fallback to base64 data -->
                    <img *ngIf="moneda.flagIconBase64" [src]="moneda.flagIconBase64" [alt]="moneda.denominacion"
                        class="currency-flag" />
                    <img *ngIf="!moneda.flagIconBase64 && moneda.flagIcon" [src]="moneda.flagIcon"
                        [alt]="moneda.denominacion" class="currency-flag" />
                    <img *ngIf="
                      !moneda.flagIconBase64 && !moneda.flagIcon && moneda.countryCode
                    " [src]="
                      'https://flagcdn.com/w320/' +
                      moneda.countryCode.toLowerCase() +
                      '.png'
                    " [alt]="moneda.denominacion" class="currency-flag" />
                    <img *ngIf="
                      !moneda.flagIconBase64 && !moneda.flagIcon && !moneda.countryCode
                    " src="assets/images/currency-placeholder.png" [alt]="moneda.denominacion" class="currency-flag" />

                    <!-- Balance value calculated from Map -->
                    <span class="currency-value">{{
                        currencyBalances.get(moneda.id!) ?? 0
                        | number : "1.0-2"
                        }}</span>
                </div>
            </div>
        </div>

        <!-- Saldo section -->
        <!-- <div class="saldo-section">
            
        </div> -->

        <!-- Sale items table -->
        <div class="sale-table">
            <table mat-table [dataSource]="ventaItems" class="mat-elevation-z2">
                <!-- Product Column -->
                <ng-container matColumnDef="productoNombre">
                    <th mat-header-cell *matHeaderCellDef>Producto</th>
                    <td mat-cell *matCellDef="let item">{{item.productoNombre}}</td>
                </ng-container>

                <!-- Quantity Column -->
                <ng-container matColumnDef="cantidad">
                    <th mat-header-cell *matHeaderCellDef>Cant.</th>
                    <td mat-cell *matCellDef="let item">{{item.cantidad}}</td>
                </ng-container>

                <!-- Price Column -->
                <ng-container matColumnDef="precio">
                    <th mat-header-cell *matHeaderCellDef>Precio</th>
                    <td mat-cell *matCellDef="let item">{{item.precio | number:'1.2-2'}}</td>
                </ng-container>

                <!-- Total Column -->
                <ng-container matColumnDef="total">
                    <th mat-header-cell *matHeaderCellDef>Total</th>
                    <td mat-cell *matCellDef="let item">{{item.total | number:'1.2-2'}}</td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef></th>
                    <td mat-cell *matCellDef="let item">
                        <button mat-icon-button color="warn" (click)="removeItem(item)">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
        </div>

        <!-- Search products section -->
        <div class="search-section">
            <form [formGroup]="searchForm">
                <mat-form-field appearance="outline" class="search-field">
                    <input matInput placeholder="BUSCAR PRODUCTOS" 
                           formControlName="searchTerm"
                           (keydown)="onSearchKeyDown($event)">
                </mat-form-field>
                <button mat-icon-button color="primary" class="search-button" (click)="searchProducts()">
                    <mat-icon>search</mat-icon>
                </button>
            </form>
        </div>

        <!-- Bottom buttons -->
        <div class="action-buttons">
            <button mat-raised-button color="primary" class="action-button">
                <mat-icon>add_shopping_cart</mat-icon>
                <span>Button</span>
            </button>
            <button mat-raised-button color="primary" class="action-button">
                <mat-icon>payment</mat-icon>
                <span>Button</span>
            </button>
            <button mat-raised-button color="primary" class="action-button">
                <mat-icon>receipt</mat-icon>
                <span>Button</span>
            </button>
        </div>
    </div>

    <!-- Right side panel -->
    <div class="right-panel">
        <!-- Categories -->
        <div class="categories">
            <button mat-raised-button color="primary" class="category-button">Categoria 2</button>
            <button mat-raised-button color="primary" class="category-button">Categoria 3</button>
        </div>

        <!-- Products grid -->
        <div class="products-grid">
            <div class="product-item" *ngFor="let producto of productos" (click)="addProduct(producto)">
                <div class="product-image">
                    <img src="assets/product-placeholder.png" alt="Product">
                </div>
                <div class="product-name">{{producto.nombre}}</div>
            </div>
        </div>

        <!-- Table number buttons -->
        <div class="tables-grid">
            <!-- Show loading spinner while mesas are loading -->
            <div *ngIf="loadingMesas" class="loading-mesas">
                <mat-spinner diameter="40"></mat-spinner>
                <span>Cargando mesas...</span>
            </div>
            
            <!-- Use actual mesa data when available -->
            <ng-container *ngIf="!loadingMesas">
                <!-- If we have mesas data, show real mesas -->
                <ng-container *ngIf="mesas.length > 0">
                    <button mat-raised-button *ngFor="let mesa of mesas" 
                        [class.table-active]="!mesa.reservado"
                        [class.table-inactive]="mesa.reservado" 
                        [matTooltip]="mesa.reservado ? 'Mesa reservada' : 'Mesa disponible'"
                        class="table-button">
                        {{mesa.numero}}
                        <mat-icon *ngIf="mesa.reservado" class="reserved-icon">event_busy</mat-icon>
                    </button>
                </ng-container>
                
                <!-- Fallback to pre-generated numbers if no mesas are available -->
                <ng-container *ngIf="mesas.length === 0">
                    <button mat-raised-button *ngFor="let i of preGeneratedTableNumbers" 
                        [class.table-active]="i <= 2"
                        [class.table-inactive]="i > 10" 
                        class="table-button">
                        {{i}}
                    </button>
                </ng-container>
            </ng-container>
        </div>

        <!-- Bottom action buttons -->
        <div class="bottom-buttons">
            <button mat-raised-button color="primary" class="bottom-button">
                <span>Button</span>
                <mat-icon>arrow_forward</mat-icon>
            </button>
            <button mat-raised-button color="primary" class="bottom-button">
                <span>Button</span>
                <mat-icon>arrow_forward</mat-icon>
            </button>
            <button mat-raised-button color="primary" class="bottom-button">
                <span>Button</span>
                <mat-icon>arrow_forward</mat-icon>
            </button>
        </div>
    </div>
</div>