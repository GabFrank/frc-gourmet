<div class="page-container">
  <div class="loading-overlay" *ngIf="isLoading">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <mat-card class="tab-container">
    <mat-tab-group animationDuration="300ms">
      <!-- Main Form Tab -->
      <mat-tab label="Información General">
        <div class="tab-content">
          <form [formGroup]="productoForm" class="form-container">
            <div class="form-layout">
              <!-- Main Form Content -->
              <div class="main-form-content">
                <!-- Nombre -->
                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width" subscriptSizing="dynamic">
                    <mat-label>Nombre</mat-label>
                    <input matInput formControlName="nombre" placeholder="Ingrese nombre del producto" required>
                    <mat-error *ngIf="productoForm.get('nombre')?.hasError('required')">
                      El nombre es requerido
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width" subscriptSizing="dynamic">
                    <mat-label>Nombre Alternativo</mat-label>
                    <input matInput formControlName="nombreAlternativo" placeholder="Nombre alternativo o abreviado">
                  </mat-form-field>
                </div>

                <!-- Categorización -->
                <div class="form-row">
                  <mat-form-field appearance="outline" class="equal-width" subscriptSizing="dynamic">
                    <mat-label>Categoría</mat-label>
                    <mat-select formControlName="categoriaId">
                      <mat-option *ngFor="let categoria of categorias" [value]="categoria.id">
                        {{ categoria.nombre }}
                      </mat-option>
                    </mat-select>
                    <mat-error *ngIf="productoForm.get('categoriaId')?.hasError('required')">
                      La categoría es requerida
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="equal-width" subscriptSizing="dynamic">
                    <mat-label>Subcategoría</mat-label>
                    <mat-select formControlName="subcategoriaId">
                      <mat-option *ngFor="let subcategoria of subcategorias" [value]="subcategoria.id">
                        {{ subcategoria.nombre }}
                      </mat-option>
                    </mat-select>
                    <mat-error *ngIf="productoForm.get('subcategoriaId')?.hasError('required')">
                      La subcategoría es requerida
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="iva-width" subscriptSizing="dynamic">
                    <mat-label>IVA (%)</mat-label>
                    <input matInput type="number" formControlName="iva" min="0" max="100">
                    <mat-error *ngIf="productoForm.get('iva')?.hasError('required')">
                      El IVA es requerido
                    </mat-error>
                    <mat-error *ngIf="productoForm.get('iva')?.hasError('min') || productoForm.get('iva')?.hasError('max')">
                      El IVA debe estar entre 0 y 100
                    </mat-error>
                  </mat-form-field>
                </div>

                <!-- Toggles in a grid -->
                <div class="toggles-grid">
                  <mat-slide-toggle formControlName="isVendible" color="primary">
                    Vendible
                  </mat-slide-toggle>

                  <mat-slide-toggle formControlName="hasStock" color="primary">
                    Controlar Stock
                  </mat-slide-toggle>

                  <mat-slide-toggle formControlName="hasVencimiento" color="primary">
                    Controlar Vencimiento
                  </mat-slide-toggle>
                  
                  <mat-slide-toggle formControlName="activo" color="primary">
                    Activo
                  </mat-slide-toggle>

                  <mat-slide-toggle formControlName="isPesable" color="primary">
                    Pesable
                  </mat-slide-toggle>

                  <mat-slide-toggle formControlName="isCombo" color="primary">
                    Combo
                  </mat-slide-toggle>

                  <mat-slide-toggle formControlName="isCompuesto" color="primary">
                    Compuesto
                  </mat-slide-toggle>

                  <mat-slide-toggle formControlName="isIngrediente" color="primary">
                    Ingrediente
                  </mat-slide-toggle>
                  
                  <mat-slide-toggle formControlName="isPromocion" color="primary">
                    Promoción
                  </mat-slide-toggle>
                </div>

                <!-- Conditional Fields -->
                <div class="form-row" *ngIf="productoForm.get('hasVencimiento')?.value">
                  <mat-form-field appearance="outline" class="full-width" subscriptSizing="dynamic">
                    <mat-label>Alertar Vencimiento (días)</mat-label>
                    <input matInput type="number" formControlName="alertarVencimientoDias" min="1">
                  </mat-form-field>
                </div>

                <!-- Additional Info -->
                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width" subscriptSizing="dynamic">
                    <mat-label>Observación</mat-label>
                    <textarea matInput formControlName="observacion" rows="2" placeholder="Observaciones"></textarea>
                  </mat-form-field>
                </div>

                <!-- Images section moved into the Información General tab -->
                <div class="images-section">
                  <h3 class="section-title">Imágenes del Producto</h3>
                  <div class="images-gallery-container">
                    <!-- Banner to show when images are pending deletion -->
                    <div *ngIf="hasPendingImageDeletions()" class="pending-deletion-banner">
                      <mat-icon color="warn">warning</mat-icon>
                      <span>Hay imágenes pendientes de eliminación que se borrarán al guardar</span>
                    </div>
                    
                    <div class="images-row">
                      <!-- All images in a row (including those marked for deletion) -->
                      <div *ngFor="let image of productImages; let i = index" 
                          class="image-card" 
                          [class.main-image]="image.isMain">
                        <div class="image-container" (click)="viewFullImage(image)">
                          <img [src]="image.imageUrl" alt="Imagen del producto">
                          
                          <!-- Overlay for deleted images -->
                          <div *ngIf="image.toDelete" class="delete-overlay" (click)="$event.stopPropagation(); restoreImage(image)">
                            <mat-icon>delete_forever</mat-icon>
                            <span class="restore-hint">Click para restaurar</span>
                          </div>
                        </div>
                        
                        <div class="main-badge" *ngIf="image.isMain">
                          <mat-icon>star</mat-icon>
                          Principal
                        </div>
                        
                        <div class="image-footer">
                          <button mat-icon-button color="warn" 
                                 [class.deleted-button]="image.toDelete"
                                 (click)="$event.stopPropagation(); image.toDelete ? restoreImage(image) : removeCurrentImage(i)" 
                                 [matTooltip]="image.toDelete ? 'Restaurar imagen' : 'Eliminar imagen'">
                            <mat-icon>{{ image.toDelete ? 'restore' : 'delete' }}</mat-icon>
                          </button>
                          <button mat-icon-button color="primary" 
                                  [disabled]="image.isMain || image.toDelete"
                                  (click)="$event.stopPropagation(); setMainImage(i)" 
                                  matTooltip="Establecer como imagen principal">
                            <mat-icon>star</mat-icon>
                          </button>
                        </div>
                      </div>
                      
                      <!-- Loading placeholder for uploading images -->
                      <div *ngIf="isUploading" class="image-card loading-card">
                        <div class="loading-content">
                          <mat-icon>cloud_upload</mat-icon>
                          <p>Subiendo imagen...</p>
                          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                        </div>
                      </div>
                      
                      <!-- Always show the add button -->
                      <div class="add-image-button">
                        <button type="button" mat-fab color="primary" (click)="openFileSelector()" matTooltip="Añadir imagen">
                          <mat-icon>add</mat-icon>
                        </button>
                      </div>
                    </div>
                    
                    <input #fileInput type="file" accept="image/*" (change)="onImageSelected($event)" style="display: none">
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </mat-tab>

      <mat-tab label="Imágenes">
        <div *ngIf="!producto?.id" class="empty-tab-message">
          <mat-icon>info</mat-icon>
          <p>Debe guardar el producto antes de poder agregar imágenes</p>
          <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="productoForm.invalid || isLoading">
            Guardar Producto
          </button>
        </div>

        <div *ngIf="producto?.id" class="images-container">
          <div class="loading-shade" *ngIf="isUploading">
            <mat-spinner diameter="50"></mat-spinner>
          </div>

          <mat-card>
            <mat-card-header>
              <mat-card-title>Imágenes del Producto</mat-card-title>
              <mat-card-subtitle>Agregue imágenes para mostrar el producto. La imagen principal se mostrará en catálogos.</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="upload-area">
                <button mat-raised-button color="primary" (click)="openFileSelector()">
                  <mat-icon>file_upload</mat-icon>
                  Seleccionar Imagen
                </button>
                <input hidden type="file" #fileInput (change)="onImageSelected($event)" accept="image/*">
                <p class="hint-text">Formatos aceptados: JPG, PNG. Tamaño máximo: 5MB</p>
              </div>

              <mat-divider class="divider"></mat-divider>

              <div *ngIf="productImages.length === 0" class="empty-list">
                <mat-icon>image</mat-icon>
                <p>No hay imágenes para este producto</p>
                <p class="hint">Seleccione una imagen para añadirla al producto</p>
              </div>

              <div class="image-grid" *ngIf="productImages.length > 0">
                <div class="image-item" *ngFor="let image of productImages">
                  <div class="image-container" (click)="viewFullImage(image)">
                    <img [src]="image.imageUrl" alt="Imagen de producto">
                    <div class="image-overlay">
                      <mat-icon>zoom_in</mat-icon>
                    </div>
                  </div>
                  <div class="image-actions">
                    <mat-checkbox 
                      [checked]="image.isMain" 
                      (change)="setMainImage(productImages.indexOf(image))"
                      [disabled]="isUploading">
                      Principal
                    </mat-checkbox>
                    <button mat-icon-button color="warn" (click)="removeCurrentImage(productImages.indexOf(image))" [disabled]="isUploading">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <mat-tab label="Presentaciones" [disabled]="!isEditing">
        <div *ngIf="!producto?.id" class="empty-tab-message">
          <mat-icon>info</mat-icon>
          <p>Debe guardar el producto antes de poder agregar presentaciones</p>
          <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="productoForm.invalid || isLoading">
            Guardar Producto
          </button>
        </div>

        <app-create-edit-presentacion 
          *ngIf="producto?.id" 
          [producto]="producto!">
        </app-create-edit-presentacion>
      </mat-tab>

      <!-- Tab 3: Precios -->
      <mat-tab label="Precios" [disabled]="!isEditing">
        <div *ngIf="!producto?.id" class="empty-tab-message">
          <mat-icon>info</mat-icon>
          <p>Debe guardar el producto antes de poder gestionar los precios</p>
          <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="productoForm.invalid || isLoading">
            Guardar Producto
          </button>
        </div>

        <div *ngIf="producto?.id" class="prices-info-container">
          <mat-card>
            <mat-card-header>
              <mat-card-title>Gestión de Precios</mat-card-title>
              <mat-card-subtitle>Los precios de venta se establecen por presentación del producto</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="info-message">
                <mat-icon>info</mat-icon>
                <div class="message-content">
                  <p><strong>¿Cómo configurar los precios?</strong></p>
                  <p>Para configurar los precios de venta, siga estos pasos:</p>
                  <ol>
                    <li>Vaya a la pestaña <strong>Presentaciones</strong></li>
                    <li>Busque la presentación para la que desea configurar precios</li>
                    <li>Haga clic en el botón <mat-icon inline>monetization_on</mat-icon> de la presentación</li>
                    <li>En la ventana que se abre, podrá definir precios en diferentes monedas para esa presentación</li>
                  </ol>
                </div>
              </div>

              <mat-divider class="divider"></mat-divider>

              <div class="presentations-summary" *ngIf="producto?.presentaciones?.length">
                <h3>Presentaciones disponibles:</h3>
                <div class="presentations-list">
                  <mat-card *ngFor="let presentacion of producto?.presentaciones" class="presentation-card">
                    <mat-card-content>
                      <div class="presentation-name">{{ presentacion.descripcion }}</div>
                      <div class="presentation-details">
                        <span>{{ presentacion.cantidad }} {{ presentacion.tipoMedida }}</span>
                        <span *ngIf="presentacion.principal" class="principal-badge">Principal</span>
                      </div>
                      <button mat-raised-button color="primary" (click)="navigateToPresentacionPrices(presentacion)">
                        <mat-icon>monetization_on</mat-icon>
                        Gestionar Precios
                      </button>
                    </mat-card-content>
                  </mat-card>
                </div>
              </div>

              <div class="empty-list" *ngIf="!producto?.presentaciones?.length">
                <mat-icon>category</mat-icon>
                <p>Este producto no tiene presentaciones configuradas</p>
                <p class="hint">Añada presentaciones en la pestaña correspondiente para poder configurar precios</p>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>
    </mat-tab-group>
  </mat-card>

  <div class="page-actions">
    <button mat-raised-button (click)="goBack()" class="action-button secondary-action">
      <mat-icon>arrow_back</mat-icon>
      Volver
    </button>
    
    <button mat-raised-button (click)="cancel()" class="action-button secondary-action" matTooltip="Restablece el formulario para un nuevo producto">
      <mat-icon>refresh</mat-icon>
      Limpiar
    </button>
    
    <button mat-raised-button *ngIf="isEditing" (click)="restablecer()" [disabled]="isLoading" class="action-button secondary-action" matTooltip="Vuelve a los datos originales del producto">
      <mat-icon>restore</mat-icon>
      Restablecer
    </button>
    
    <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="productoForm.invalid || isLoading" class="action-button primary-action">
      <mat-spinner *ngIf="isLoading" diameter="20" class="spinner-button"></mat-spinner>
      <span *ngIf="!isLoading">
        <mat-icon>save</mat-icon>
        {{ isEditing ? 'Actualizar' : 'Guardar' }}
      </span>
    </button>
  </div>
</div>
