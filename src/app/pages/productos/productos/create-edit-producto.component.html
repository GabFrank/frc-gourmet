<div class="page-container">
  <div class="page-header">
    <h1>{{ isEditing ? 'Editar' : 'Crear' }} Producto</h1>
  </div>

  <div class="loading-overlay" *ngIf="isLoading">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <mat-card class="tab-container">
    <mat-tab-group animationDuration="300ms">
      <!-- Tab 1: Informaciones Generales -->
      <mat-tab label="Informaciones Generales">
        <div class="tab-content">
          <form [formGroup]="productoForm" class="form-container">
            <!-- Información básica -->
            <h3>Información Básica</h3>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Nombre</mat-label>
                <input matInput formControlName="nombre" placeholder="Ingrese nombre del producto" required>
                <mat-error *ngIf="productoForm.get('nombre')?.hasError('required')">
                  El nombre es requerido
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Nombre Alternativo</mat-label>
                <input matInput formControlName="nombreAlternativo" placeholder="Nombre alternativo o abreviado">
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Código</mat-label>
                <input matInput formControlName="codigo" placeholder="Código de referencia">
              </mat-form-field>
            </div>

            <!-- Categorización -->
            <h3>Categorización</h3>

            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Categoría</mat-label>
                <mat-select formControlName="categoriaId">
                  <mat-option *ngFor="let categoria of categorias" [value]="categoria.id">
                    {{ categoria.nombre }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="productoForm.get('categoriaId')?.hasError('required')">
                  La categoría es requerida
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Subcategoría</mat-label>
                <mat-select formControlName="subcategoriaId" [disabled]="!productoForm.get('categoriaId')?.value">
                  <mat-option *ngFor="let subcategoria of subcategorias" [value]="subcategoria.id">
                    {{ subcategoria.nombre }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="productoForm.get('subcategoriaId')?.hasError('required')">
                  La subcategoría es requerida
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Precios y costos -->
            <h3>Precios y Costos</h3>

            <div class="form-row">
              <mat-form-field appearance="outline" class="one-third-width">
                <mat-label>Precio (Gs.)</mat-label>
                <input matInput type="number" formControlName="precio" min="0">
                <mat-error *ngIf="productoForm.get('precio')?.hasError('required')">
                  El precio es requerido
                </mat-error>
                <mat-error *ngIf="productoForm.get('precio')?.hasError('min')">
                  El precio no puede ser negativo
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="one-third-width">
                <mat-label>Costo (Gs.)</mat-label>
                <input matInput type="number" formControlName="costo" min="0">
                <mat-error *ngIf="productoForm.get('costo')?.hasError('min')">
                  El costo no puede ser negativo
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="one-third-width">
                <mat-label>IVA (%)</mat-label>
                <input matInput type="number" formControlName="iva" min="0" max="100">
                <mat-error *ngIf="productoForm.get('iva')?.hasError('required')">
                  El IVA es requerido
                </mat-error>
                <mat-error *ngIf="productoForm.get('iva')?.hasError('min') || productoForm.get('iva')?.hasError('max')">
                  El IVA debe estar entre 0 y 100
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Inventario -->
            <h3>Inventario</h3>

            <div class="form-row checkbox-row">
              <mat-slide-toggle formControlName="hasStock" color="primary">
                Controlar Stock
              </mat-slide-toggle>

              <mat-slide-toggle formControlName="hasVencimiento" color="primary">
                Controlar Vencimiento
              </mat-slide-toggle>
            </div>

            <div class="form-row" *ngIf="productoForm.get('hasStock')?.value">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Stock Actual</mat-label>
                <input matInput type="number" formControlName="stock" min="0">
                <mat-error *ngIf="productoForm.get('stock')?.hasError('min')">
                  El stock no puede ser negativo
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row" *ngIf="productoForm.get('hasVencimiento')?.value">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Alertar Vencimiento (días)</mat-label>
                <input matInput type="number" formControlName="alertarVencimientoDias" min="1">
              </mat-form-field>
            </div>

            <!-- Características -->
            <h3>Características</h3>

            <div class="form-row checkbox-row multiple-toggles">
              <div class="toggle-group">
                <mat-slide-toggle formControlName="isVendible" color="primary">
                  Vendible
                </mat-slide-toggle>

                <mat-slide-toggle formControlName="isPesable" color="primary">
                  Pesable
                </mat-slide-toggle>
              </div>

              <div class="toggle-group">
                <mat-slide-toggle formControlName="isCombo" color="primary">
                  Combo
                </mat-slide-toggle>

                <mat-slide-toggle formControlName="isIngrediente" color="primary">
                  Ingrediente
                </mat-slide-toggle>
              </div>

              <div class="toggle-group">
                <mat-slide-toggle formControlName="isPromocion" color="primary">
                  Promoción
                </mat-slide-toggle>

                <mat-slide-toggle formControlName="activo" color="primary">
                  Activo
                </mat-slide-toggle>
              </div>
            </div>

            <!-- Descripción y observaciones -->
            <h3>Descripción y Observaciones</h3>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Descripción</mat-label>
                <textarea matInput formControlName="descripcion" rows="2" placeholder="Descripción detallada del producto"></textarea>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Observación</mat-label>
                <textarea matInput formControlName="observacion" rows="2" placeholder="Observaciones adicionales"></textarea>
              </mat-form-field>
            </div>

            <!-- Imagen -->
            <h3>Imagen del Producto</h3>

            <div class="image-container">
              <div class="image-preview" *ngIf="imagePreviewUrl">
                <img [src]="imagePreviewUrl" alt="Vista previa">
                <button type="button" mat-mini-fab color="warn" (click)="removeImage()" class="remove-image-btn">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>

              <div class="image-upload" *ngIf="!imagePreviewUrl">
                <button type="button" mat-stroked-button color="primary" (click)="fileInput.click()">
                  <mat-icon>add_photo_alternate</mat-icon>
                  Seleccionar Imagen
                </button>
                <p class="hint-text">Formatos: JPG, PNG, GIF (máx. 5MB)</p>
              </div>

              <input #fileInput type="file" accept="image/*" (change)="onImageSelected($event)" style="display: none">
            </div>
          </form>
        </div>
      </mat-tab>

      <!-- Tab 2: Presentaciones -->
      <mat-tab label="Presentaciones">
        <div class="tab-content">
          <div class="placeholder-content">
            <h3>Presentaciones del Producto</h3>
            <p>Aquí se podrán gestionar las diferentes presentaciones del producto.</p>
            <div class="empty-state">
              <mat-icon>list_alt</mat-icon>
              <p>No hay presentaciones configuradas</p>
              <button mat-raised-button color="primary">
                <mat-icon>add</mat-icon>
                Agregar Presentación
              </button>
            </div>
          </div>
        </div>
      </mat-tab>

      <!-- Tab 3: Precios -->
      <mat-tab label="Precios">
        <div class="tab-content">
          <div class="placeholder-content">
            <h3>Configuración de Precios</h3>
            <p>Aquí se podrán configurar los diferentes precios del producto según lista de precios y tipo de cliente.</p>
            <div class="empty-state">
              <mat-icon>attach_money</mat-icon>
              <p>No hay precios adicionales configurados</p>
              <button mat-raised-button color="primary">
                <mat-icon>add</mat-icon>
                Agregar Precio
              </button>
            </div>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </mat-card>

  <div class="page-actions">
    <button mat-button (click)="cancel()" [disabled]="isLoading">Cancelar</button>
    <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="productoForm.invalid || isLoading">
      <mat-spinner *ngIf="isLoading" diameter="20" class="spinner-button"></mat-spinner>
      <span *ngIf="!isLoading">{{ isEditing ? 'Actualizar' : 'Guardar' }}</span>
    </button>
  </div>
</div>
