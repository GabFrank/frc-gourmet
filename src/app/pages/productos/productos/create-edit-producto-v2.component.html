<div class="page-container">
  <div class="loading-overlay" *ngIf="isLoading">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <mat-card>
    <div class="tab-content">
      <form [formGroup]="productoForm" class="form-container">
        <div class="form-layout">
          <!-- Main Form Content -->
          <div class="main-form-content">
            <!-- Top form section with image -->
            <div class="top-form-section">
              <!-- Basic Info Fields -->
              <div class="basic-info-fields">
                <!-- Nombre -->
                <div class="form-row">
                  <mat-form-field
                    appearance="outline"
                    class="full-width"
                    subscriptSizing="dynamic"
                  >
                    <mat-label>Nombre</mat-label>
                    <input
                      matInput
                      formControlName="nombre"
                      placeholder="Ingrese nombre del producto"
                      required
                    />
                    <mat-error
                      *ngIf="
                        productoForm.get('nombre')?.hasError('required')
                      "
                    >
                      El nombre es requerido
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field
                    appearance="outline"
                    class="full-width"
                    subscriptSizing="dynamic"
                  >
                    <mat-label>Nombre Alternativo</mat-label>
                    <input
                      matInput
                      formControlName="nombreAlternativo"
                      placeholder="Nombre alternativo o abreviado"
                    />
                  </mat-form-field>
                </div>

                <!-- Categorización -->
                <div class="form-row category-row">
                  <mat-form-field
                    appearance="outline"
                    class="categoria-field"
                    subscriptSizing="dynamic"
                  >
                    <mat-label>Categoría</mat-label>
                    <mat-select formControlName="categoriaId">
                      <mat-option
                        *ngFor="let categoria of categorias"
                        [value]="categoria.id"
                      >
                        {{ categoria.nombre }}
                      </mat-option>
                    </mat-select>
                    <mat-error
                      *ngIf="
                        productoForm
                          .get('categoriaId')
                          ?.hasError('required')
                      "
                    >
                      La categoría es requerida
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field
                    appearance="outline"
                    class="subcategoria-field"
                    subscriptSizing="dynamic"
                  >
                    <mat-label>Subcategoría</mat-label>
                    <mat-select formControlName="subcategoriaId">
                      <mat-option
                        *ngFor="let subcategoria of subcategorias"
                        [value]="subcategoria.id"
                      >
                        {{ subcategoria.nombre }}
                      </mat-option>
                    </mat-select>
                    <mat-error
                      *ngIf="
                        productoForm
                          .get('subcategoriaId')
                          ?.hasError('required')
                      "
                    >
                      La subcategoría es requerida
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field
                    appearance="outline"
                    class="iva-width"
                    subscriptSizing="dynamic"
                  >
                    <mat-label>IVA (%)</mat-label>
                    <input
                      matInput
                      type="number"
                      formControlName="iva"
                      min="0"
                      max="100"
                    />
                    <mat-error
                      *ngIf="productoForm.get('iva')?.hasError('required')"
                    >
                      El IVA es requerido
                    </mat-error>
                    <mat-error
                      *ngIf="
                        productoForm.get('iva')?.hasError('min') ||
                        productoForm.get('iva')?.hasError('max')
                      "
                    >
                      El IVA debe estar entre 0 y 100
                    </mat-error>
                  </mat-form-field>
                </div>
              </div>
            </div>

            <!-- Toggles in a grid -->
            <div class="toggles-grid">
              <mat-slide-toggle
                formControlName="isVendible"
                color="primary"
              >
                Vendible
              </mat-slide-toggle>

              <mat-slide-toggle formControlName="hasStock" color="primary">
                Controlar Stock
              </mat-slide-toggle>

              <mat-slide-toggle
                formControlName="hasVencimiento"
                color="primary"
              >
                Controlar Vencimiento
              </mat-slide-toggle>

              <mat-slide-toggle
                formControlName="hasVariaciones"
                color="primary"
              >
                Posee variaciones
              </mat-slide-toggle>

              <mat-slide-toggle formControlName="activo" color="primary">
                Activo
              </mat-slide-toggle>

              <mat-slide-toggle formControlName="isPesable" color="primary">
                Pesable
              </mat-slide-toggle>

              <mat-slide-toggle formControlName="isCombo" color="primary">
                Combo
              </mat-slide-toggle>

              <mat-slide-toggle
                formControlName="isCompuesto"
                color="primary"
              >
                Posee receta
              </mat-slide-toggle>

              <mat-slide-toggle
                formControlName="isIngrediente"
                color="primary"
              >
                Ingrediente
              </mat-slide-toggle>

              <mat-slide-toggle
                formControlName="isPromocion"
                color="primary"
              >
                Promoción
              </mat-slide-toggle>
            </div>

            <div class="images-row">
              <!-- All images in a row (including those marked for deletion) -->
              <div
                *ngFor="let image of productImages; let i = index"
                class="image-card"
                [class.main-image]="image.isMain"
              >
                <div class="image-container" (click)="viewFullImage(image)">
                  <img [src]="image.imageUrl" alt="Imagen del producto" />

                  <!-- Overlay for deleted images -->
                  <div
                    *ngIf="image.toDelete"
                    class="delete-overlay"
                    (click)="$event.stopPropagation(); restoreImage(image)"
                  >
                    <mat-icon>delete_forever</mat-icon>
                    <span class="restore-hint">Click para restaurar</span>
                  </div>
                </div>

                <div class="main-badge" *ngIf="image.isMain">
                  <mat-icon>star</mat-icon>
                  Principal
                </div>

                <div class="image-footer">
                  <button
                    mat-icon-button
                    color="warn"
                    [class.deleted-button]="image.toDelete"
                    (click)="
                      $event.stopPropagation();
                      image.toDelete
                        ? restoreImage(image)
                        : removeCurrentImage(i)
                    "
                    [matTooltip]="
                      image.toDelete
                        ? 'Restaurar imagen'
                        : 'Eliminar imagen'
                    "
                  >
                    <mat-icon>{{
                      image.toDelete ? "restore" : "delete"
                    }}</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    color="primary"
                    [disabled]="image.isMain || image.toDelete"
                    (click)="$event.stopPropagation(); setMainImage(i)"
                    matTooltip="Establecer como imagen principal"
                  >
                    <mat-icon>star</mat-icon>
                  </button>
                </div>
              </div>

              <!-- Loading placeholder for uploading images -->
              <div *ngIf="isUploading" class="image-card loading-card">
                <div class="loading-content">
                  <mat-icon>cloud_upload</mat-icon>
                  <p>Subiendo imagen...</p>
                  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                </div>
              </div>

              <!-- Always show the add button -->
              <div class="add-image-button">
                <button
                  type="button"
                  mat-fab
                  color="primary"
                  (click)="openFileSelector()"
                  matTooltip="Añadir imagen"
                >
                  <mat-icon>add</mat-icon>
                </button>
              </div>
            </div>

            <input
              #fileInput
              type="file"
              accept="image/*"
              (change)="onImageSelected($event)"
              style="display: none"
            />

            <div class="page-actions">
              <button
                mat-raised-button
                *ngIf="isEditing"
                color="warn"
                (click)="deleteProducto()"
                [disabled]="isLoading"
                class="action-button secondary-action"
                matTooltip="Eliminar este producto"
              >
                <mat-icon>delete</mat-icon>
                Eliminar
              </button>

              <button
                mat-raised-button
                color="primary"
                (click)="onSubmit()"
                [disabled]="productoForm.invalid || isLoading"
                class="action-button primary-action"
              >
                <mat-spinner
                  *ngIf="isLoading"
                  diameter="20"
                  class="spinner-button"
                ></mat-spinner>
                <span *ngIf="!isLoading">
                  <mat-icon>save</mat-icon>
                  {{ isEditing ? "Actualizar" : "Guardar" }}
                </span>
              </button>
            </div>

            <!-- Default Presentacion Form (when hasVariaciones is false) -->
            <div
              *ngIf="!productoForm.get('hasVariaciones')?.value"
              class="default-presentacion-form"
            >
              <h4 class="section-title">Presentación Principal</h4>

              <!-- First row: Tipo de Medida and Cantidad -->
              <div class="form-row">
                <mat-form-field
                  appearance="outline"
                  class="equal-width"
                  subscriptSizing="dynamic"
                >
                  <mat-label>Tipo de Medida</mat-label>
                  <mat-select
                    formControlName="defaultPresentacionTipoMedida"
                  >
                    <mat-option value="UNIDAD">Unidad</mat-option>
                    <mat-option value="PAQUETE">Paquete</mat-option>
                    <mat-option value="GRAMO">Gramo</mat-option>
                    <mat-option value="LITRO">Litro</mat-option>
                  </mat-select>
                  <mat-hint>Unidad de medida del producto</mat-hint>
                </mat-form-field>

                <mat-form-field
                  appearance="outline"
                  class="equal-width"
                  subscriptSizing="dynamic"
                >
                  <mat-label>Cantidad a descontar del stock</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="defaultPresentacionCantidad"
                    min="0"
                    step="0.01"
                  />
                  <mat-hint
                    >Cantidad que se descuenta del inventario</mat-hint
                  >
                </mat-form-field>
              </div>

              <!-- Second row: Tipo de Código and Código -->
              <div class="form-row">
                <mat-form-field
                  appearance="outline"
                  class="equal-width"
                  subscriptSizing="dynamic"
                >
                  <mat-label>Tipo de Código</mat-label>
                  <mat-select
                    formControlName="defaultPresentacionTipoCodigo"
                  >
                    <mat-option [value]="TipoCodigo.MANUAL"
                      >Manual</mat-option
                    >
                    <mat-option [value]="TipoCodigo.BARRA"
                      >Código de Barras</mat-option
                    >
                    <mat-option [value]="TipoCodigo.QR"
                      >Código QR</mat-option
                    >
                  </mat-select>
                  <mat-hint>Formato del código</mat-hint>
                </mat-form-field>

                <mat-form-field
                  appearance="outline"
                  class="equal-width"
                  subscriptSizing="dynamic"
                >
                  <mat-label>Código</mat-label>
                  <input
                    matInput
                    formControlName="defaultPresentacionCodigo"
                    placeholder="Código opcional"
                  />
                  <mat-hint>Código de identificación (opcional)</mat-hint>
                </mat-form-field>
              </div>

              <!-- Receta Field (shows when isCompuesto is true) -->
              <div
                *ngIf="productoForm.get('isCompuesto')?.value"
                class="receta-section"
              >
                <h4 class="section-title">Receta Asociada</h4>
                <div class="form-row">
                  <mat-form-field
                    appearance="outline"
                    class="full-width"
                    subscriptSizing="dynamic"
                  >
                    <mat-label>Receta</mat-label>
                    <input
                      type="text"
                      matInput
                      formControlName="recetaSearch"
                      [matAutocomplete]="autoReceta"
                      placeholder="Buscar receta..."
                    />
                    <mat-spinner
                      *ngIf="isLoading"
                      matSuffix
                      diameter="20"
                    ></mat-spinner>
                    <button
                      *ngIf="selectedRecetaModel"
                      matSuffix
                      mat-icon-button
                      type="button"
                      (click)="clearRecetaSelection()"
                    >
                      <mat-icon>clear</mat-icon>
                    </button>
                    <mat-autocomplete
                      #autoReceta="matAutocomplete"
                      [displayWith]="displayRecetaFn"
                      (optionSelected)="onRecetaSelected($event)"
                    >
                      <mat-option
                        *ngFor="let receta of filteredRecetas | async"
                        [value]="receta"
                      >
                        {{ receta.optionText }}
                      </mat-option>
                      <mat-option
                        *ngIf="(filteredRecetas | async)?.length === 0"
                        [disabled]="true"
                      >
                        No se encontraron recetas
                      </mat-option>
                    </mat-autocomplete>
                    <mat-hint
                      >Asocie una receta al producto para cálculos de costos y
                      gestión de inventario</mat-hint
                    >
                  </mat-form-field>
                </div>

                <!-- Variation Field (shows when a recipe is selected and has variations) -->
                <div class="form-row" *ngIf="variaciones.length > 0">
                  <mat-form-field
                    appearance="outline"
                    class="full-width"
                    subscriptSizing="dynamic"
                  >
                    <mat-label>Variación de Receta</mat-label>
                    <mat-select formControlName="variacionId">
                      <mat-option
                        *ngFor="let variacion of variaciones"
                        [value]="variacion.id"
                      >
                        {{ variacion.nombre }}
                        {{ variacion.principal ? "(Principal)" : "" }}
                      </mat-option>
                    </mat-select>
                    <mat-hint
                      >Seleccione la variación específica de la receta para el
                      cálculo de costos</mat-hint
                    >
                  </mat-form-field>
                </div>

                <!-- Recipe Cost Information -->
                <div *ngIf="selectedRecetaModel" class="recipe-cost-info">
                  <div class="cost-card">
                    <div class="cost-details">
                      <div class="cost-item">
                        <span class="cost-label"
                          >Costo de
                          {{
                            variaciones.length > 0 ? "Variación" : "Receta"
                          }}:</span
                        >
                        <span class="cost-value"
                          >{{ defaultMonedaSimbolo }}
                          {{ recipeTotalCost | number : "1.2-2" }}</span
                        >
                      </div>
                      <div class="cost-item suggested-price">
                        <span class="cost-label">Precio Sugerido:</span>
                        <span class="cost-value"
                          >{{ defaultMonedaSimbolo }}
                          {{ recipeSuggestedPrice | number : "1.2-2" }}</span
                        >
                        <span class="cost-hint">(Food Cost: 35%)</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Precios Section -->
              <div class="precios-section">
                <div class="precios-header">
                  <h4 class="section-title">Precios de Venta</h4>
                  <button
                    mat-raised-button
                    color="primary"
                    [disabled]="!isEditing || !producto?.id"
                    (click)="addDefaultPresentacionPrecio()"
                    matTooltip="Debe guardar el producto primero para agregar precios"
                  >
                    <mat-icon>add</mat-icon>
                    Nuevo Precio
                  </button>
                </div>

                <div
                  class="precios-table-container"
                  [class.disabled]="!isEditing || !producto?.id"
                >
                  <!-- Empty state message -->
                  <div
                    *ngIf="
                      !defaultPresentacionPrecios ||
                      defaultPresentacionPrecios.length === 0
                    "
                    class="empty-precios"
                  >
                    <mat-icon>monetization_on</mat-icon>
                    <p>
                      No hay precios configurados para esta presentación
                    </p>
                    <p class="hint" *ngIf="isEditing && producto?.id">
                      Haga clic en "Nuevo Precio" para agregar
                    </p>
                    <p class="hint" *ngIf="!isEditing || !producto?.id">
                      Debe guardar el producto primero para agregar precios
                    </p>
                  </div>

                  <!-- Precios table -->
                  <table
                    mat-table
                    [dataSource]="defaultPresentacionPrecios || []"
                    class="mat-elevation-z1"
                    *ngIf="
                      defaultPresentacionPrecios &&
                      defaultPresentacionPrecios.length > 0
                    "
                  >
                    <!-- Moneda Column -->
                    <ng-container matColumnDef="moneda">
                      <th mat-header-cell *matHeaderCellDef>Moneda</th>
                      <td mat-cell *matCellDef="let item">
                        {{ item.moneda?.simbolo }} -
                        {{ item.moneda?.denominacion }}
                      </td>
                    </ng-container>

                    <!-- Valor Column -->
                    <ng-container matColumnDef="valor">
                      <th mat-header-cell *matHeaderCellDef>Valor</th>
                      <td mat-cell *matCellDef="let item">
                        {{ item.valor | number : "1.0-2" }}
                      </td>
                    </ng-container>

                    <!-- CMV Column (Food Cost %) -->
                    <ng-container matColumnDef="cmv">
                      <th
                        mat-header-cell
                        *matHeaderCellDef
                        matTooltip="Costo sobre Margen de Venta"
                      >
                        CMV %
                      </th>
                      <td mat-cell *matCellDef="let item">
                        <ng-container
                          *ngIf="recipeTotalCost > 0 && item.valor > 0"
                        >
                          <span
                            [style.color]="
                              getCMVColor(
                                (recipeTotalCost / item.valor) * 100
                              )
                            "
                            [style.font-weight]="'500'"
                          >
                            {{
                              (recipeTotalCost / item.valor) * 100
                                | number : "1.0-2"
                            }}%
                          </span>
                        </ng-container>
                        <span
                          *ngIf="recipeTotalCost === 0 || item.valor === 0"
                          >N/A</span
                        >
                      </td>
                    </ng-container>

                    <!-- Tipo Precio Column -->
                    <ng-container matColumnDef="tipoPrecio">
                      <th mat-header-cell *matHeaderCellDef>Tipo</th>
                      <td mat-cell *matCellDef="let item">
                        {{ item.tipoPrecio?.descripcion || "Estándar" }}
                      </td>
                    </ng-container>

                    <!-- Principal Column -->
                    <ng-container matColumnDef="principal">
                      <th mat-header-cell *matHeaderCellDef>Principal</th>
                      <td mat-cell *matCellDef="let item">
                        <mat-icon *ngIf="item.principal" color="primary"
                          >check_circle</mat-icon
                        >
                        <mat-icon *ngIf="!item.principal" color="disabled"
                          >radio_button_unchecked</mat-icon
                        >
                      </td>
                    </ng-container>

                    <!-- Activo Column -->
                    <ng-container matColumnDef="activo">
                      <th mat-header-cell *matHeaderCellDef>Activo</th>
                      <td mat-cell *matCellDef="let item">
                        <span
                          class="status-badge"
                          [ngClass]="item.activo ? 'active' : 'inactive'"
                        >
                          {{ item.activo ? "Activo" : "Inactivo" }}
                        </span>
                      </td>
                    </ng-container>

                    <!-- Actions Column -->
                    <ng-container matColumnDef="acciones">
                      <th mat-header-cell *matHeaderCellDef>Acciones</th>
                      <td
                        mat-cell
                        *matCellDef="let item"
                        style="
                          display: flex;
                          flex-direction: row;
                          align-items: center;
                        "
                      >
                        <button
                          mat-icon-button
                          color="primary"
                          (click)="editDefaultPresentacionPrecio(item)"
                          matTooltip="Editar"
                        >
                          <mat-icon>edit</mat-icon>
                        </button>
                        <button
                          mat-icon-button
                          color="warn"
                          (click)="deleteDefaultPresentacionPrecio(item)"
                          matTooltip="Eliminar"
                        >
                          <mat-icon>delete</mat-icon>
                        </button>
                      </td>
                    </ng-container>

                    <tr
                      mat-header-row
                      *matHeaderRowDef="
                        preciosDisplayedColumns;
                        sticky: true
                      "
                    ></tr>
                    <tr
                      mat-row
                      *matRowDef="let row; columns: preciosDisplayedColumns"
                    ></tr>
                  </table>
                </div>
              </div>
            </div>

            <!-- Presentaciones Tab Section (when hasVariaciones is true and producto exists) -->
            <div 
              *ngIf="productoForm.get('hasVariaciones')?.value && producto?.id"
              class="presentaciones-wrapper"
            >
              <div *ngIf="producto && producto.presentaciones && producto.presentaciones.length > 0">
                <mat-tab-group (selectedTabChange)="onTabChange($event.index)">
                  <mat-tab *ngFor="let presentacion of producto?.presentaciones" [label]="presentacion.descripcion || 'Sin descripción'">
                    <div class="presentacion-tab-content">
                      <!-- Presentacion Form -->
                      <div class="presentacion-form">
                        <div class="form-row">
                          <mat-form-field
                            appearance="outline"
                            class="full-width"
                            subscriptSizing="dynamic"
                          >
                            <mat-label>Descripción</mat-label>
                            <input
                              matInput
                              [(ngModel)]="presentacion.descripcion"
                              [ngModelOptions]="{standalone: true}"
                              placeholder="Descripción de la presentación"
                              required
                            />
                          </mat-form-field>
                        </div>
                        
                        <div class="form-row">
                          <mat-form-field
                            appearance="outline"
                            class="equal-width"
                            subscriptSizing="dynamic"
                          >
                            <mat-label>Tipo de Medida</mat-label>
                            <mat-select [(ngModel)]="presentacion.tipoMedida" [ngModelOptions]="{standalone: true}">
                              <mat-option value="UNIDAD">Unidad</mat-option>
                              <mat-option value="PAQUETE">Paquete</mat-option>
                              <mat-option value="GRAMO">Gramo</mat-option>
                              <mat-option value="LITRO">Litro</mat-option>
                            </mat-select>
                          </mat-form-field>
                          
                          <mat-form-field
                            appearance="outline"
                            class="equal-width"
                            subscriptSizing="dynamic"
                          >
                            <mat-label>Cantidad</mat-label>
                            <input
                              matInput
                              type="number"
                              [(ngModel)]="presentacion.cantidad"
                              [ngModelOptions]="{standalone: true}"
                              min="0.01"
                              step="0.01"
                            />
                          </mat-form-field>
                        </div>
                        
                        <div class="form-row" style="justify-content: space-between">
                          <div>
                            <mat-slide-toggle
                              [(ngModel)]="presentacion.principal"
                              [ngModelOptions]="{standalone: true}"
                              color="primary"
                            >
                              Principal
                            </mat-slide-toggle>
                          </div>
                          
                          <div>
                            <mat-slide-toggle
                              [(ngModel)]="presentacion.activo"
                              [ngModelOptions]="{standalone: true}"
                              color="primary"
                            >
                              Activo
                            </mat-slide-toggle>
                          </div>
                          
                          <div>
                            <button
                              mat-raised-button
                              color="primary"
                              (click)="editPresentacion(presentacion)"
                            >
                              <mat-icon>save</mat-icon>
                              Actualizar
                            </button>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Precios Section for this presentacion -->
                      <div class="precios-section">
                        <div class="precios-header">
                          <h4 class="section-title">Precios de Venta</h4>
                          <button
                            mat-raised-button
                            color="primary"
                            (click)="addDefaultPresentacionPrecio()"
                          >
                            <mat-icon>add</mat-icon>
                            Nuevo Precio
                          </button>
                        </div>
                        
                        <div class="precios-table-container">
                          <!-- Empty state message -->
                          <div
                            *ngIf="
                              !defaultPresentacionPrecios ||
                              defaultPresentacionPrecios.length === 0
                            "
                            class="empty-precios"
                          >
                            <mat-icon>monetization_on</mat-icon>
                            <p>
                              No hay precios configurados para esta presentación
                            </p>
                            <p class="hint">
                              Haga clic en "Nuevo Precio" para agregar
                            </p>
                          </div>
                          
                          <!-- Precios table -->
                          <table
                            mat-table
                            [dataSource]="defaultPresentacionPrecios || []"
                            class="mat-elevation-z1"
                            *ngIf="
                              defaultPresentacionPrecios &&
                              defaultPresentacionPrecios.length > 0
                            "
                          >
                            <!-- Reuse the same table columns from before -->
                            <ng-container matColumnDef="moneda">
                              <th mat-header-cell *matHeaderCellDef>Moneda</th>
                              <td mat-cell *matCellDef="let item">
                                {{ item.moneda?.simbolo }} -
                                {{ item.moneda?.denominacion }}
                              </td>
                            </ng-container>

                            <ng-container matColumnDef="valor">
                              <th mat-header-cell *matHeaderCellDef>Valor</th>
                              <td mat-cell *matCellDef="let item">
                                {{ item.valor | number : "1.0-2" }}
                              </td>
                            </ng-container>

                            <ng-container matColumnDef="cmv">
                              <th
                                mat-header-cell
                                *matHeaderCellDef
                                matTooltip="Costo sobre Margen de Venta"
                              >
                                CMV %
                              </th>
                              <td mat-cell *matCellDef="let item">
                                <ng-container
                                  *ngIf="recipeTotalCost > 0 && item.valor > 0"
                                >
                                  <span
                                    [style.color]="
                                      getCMVColor(
                                        (recipeTotalCost / item.valor) * 100
                                      )
                                    "
                                    [style.font-weight]="'500'"
                                  >
                                    {{
                                      (recipeTotalCost / item.valor) * 100
                                        | number : "1.0-2"
                                    }}%
                                  </span>
                                </ng-container>
                                <span
                                  *ngIf="recipeTotalCost === 0 || item.valor === 0"
                                  >N/A</span
                                >
                              </td>
                            </ng-container>

                            <ng-container matColumnDef="tipoPrecio">
                              <th mat-header-cell *matHeaderCellDef>Tipo</th>
                              <td mat-cell *matCellDef="let item">
                                {{ item.tipoPrecio?.descripcion || "Estándar" }}
                              </td>
                            </ng-container>

                            <ng-container matColumnDef="principal">
                              <th mat-header-cell *matHeaderCellDef>Principal</th>
                              <td mat-cell *matCellDef="let item">
                                <mat-icon *ngIf="item.principal" color="primary"
                                  >check_circle</mat-icon
                                >
                                <mat-icon *ngIf="!item.principal" color="disabled"
                                  >radio_button_unchecked</mat-icon
                                >
                              </td>
                            </ng-container>

                            <ng-container matColumnDef="activo">
                              <th mat-header-cell *matHeaderCellDef>Activo</th>
                              <td mat-cell *matCellDef="let item">
                                <span
                                  class="status-badge"
                                  [ngClass]="item.activo ? 'active' : 'inactive'"
                                >
                                  {{ item.activo ? "Activo" : "Inactivo" }}
                                </span>
                              </td>
                            </ng-container>

                            <ng-container matColumnDef="acciones">
                              <th mat-header-cell *matHeaderCellDef>Acciones</th>
                              <td
                                mat-cell
                                *matCellDef="let item"
                                style="
                                  display: flex;
                                  flex-direction: row;
                                  align-items: center;
                                "
                              >
                                <button
                                  mat-icon-button
                                  color="primary"
                                  (click)="editDefaultPresentacionPrecio(item)"
                                  matTooltip="Editar"
                                >
                                  <mat-icon>edit</mat-icon>
                                </button>
                                <button
                                  mat-icon-button
                                  color="warn"
                                  (click)="deleteDefaultPresentacionPrecio(item)"
                                  matTooltip="Eliminar"
                                >
                                  <mat-icon>delete</mat-icon>
                                </button>
                              </td>
                            </ng-container>

                            <tr
                              mat-header-row
                              *matHeaderRowDef="
                                preciosDisplayedColumns;
                                sticky: true
                              "
                            ></tr>
                            <tr
                              mat-row
                              *matRowDef="let row; columns: preciosDisplayedColumns"
                            ></tr>
                          </table>
                        </div>
                      </div>
                      
                      <!-- Codigos Section -->
                      <div class="codigos-section">
                        <div class="codigos-header">
                          <h4 class="section-title">Códigos</h4>
                          <button
                            mat-raised-button
                            color="primary"
                            (click)="addPresentacionCodigo(presentacion)"
                          >
                            <mat-icon>add</mat-icon>
                            Nuevo Código
                          </button>
                        </div>
                        
                        <div class="codigos-table-container">
                          <!-- Loading state -->
                          <div *ngIf="loadingCodigos" class="loading-content" style="padding: 20px; text-align: center;">
                            <mat-spinner diameter="30" style="margin: 0 auto;"></mat-spinner>
                            <p>Cargando códigos...</p>
                          </div>
                          
                          <!-- Empty state message -->
                          <div
                            *ngIf="
                              !loadingCodigos && 
                              (!presentacionCodigos[presentacion.id!] || 
                               presentacionCodigos[presentacion.id!].length === 0)
                            "
                            class="empty-codigos"
                          >
                            <mat-icon>qr_code</mat-icon>
                            <p>
                              No hay códigos configurados para esta presentación
                            </p>
                            <p class="hint">
                              Haga clic en "Nuevo Código" para agregar
                            </p>
                          </div>
                          
                          <!-- Codigos table -->
                          <table
                            mat-table
                            [dataSource]="presentacionCodigos[presentacion.id!] || []"
                            class="mat-elevation-z1"
                            *ngIf="
                              !loadingCodigos && 
                              presentacionCodigos[presentacion.id!] && 
                              presentacionCodigos[presentacion.id!].length > 0
                            "
                          >
                            <!-- Codigo Column -->
                            <ng-container matColumnDef="codigo">
                              <th mat-header-cell *matHeaderCellDef>Código</th>
                              <td mat-cell *matCellDef="let item">
                                {{ item.codigo }}
                              </td>
                            </ng-container>

                            <!-- Tipo Codigo Column -->
                            <ng-container matColumnDef="tipoCodigo">
                              <th mat-header-cell *matHeaderCellDef>Tipo</th>
                              <td mat-cell *matCellDef="let item">
                                {{ item.tipoCodigo === 'MANUAL' ? 'Manual' : 
                                   item.tipoCodigo === 'BARRA' ? 'Código de Barras' : 
                                   item.tipoCodigo === 'QR' ? 'Código QR' : item.tipoCodigo }}
                              </td>
                            </ng-container>

                            <ng-container matColumnDef="principal">
                              <th mat-header-cell *matHeaderCellDef>Principal</th>
                              <td mat-cell *matCellDef="let item">
                                <mat-icon *ngIf="item.principal" color="primary"
                                  >check_circle</mat-icon
                                >
                                <mat-icon *ngIf="!item.principal" color="disabled"
                                  >radio_button_unchecked</mat-icon
                                >
                              </td>
                            </ng-container>

                            <ng-container matColumnDef="activo">
                              <th mat-header-cell *matHeaderCellDef>Activo</th>
                              <td mat-cell *matCellDef="let item">
                                <span
                                  class="status-badge"
                                  [ngClass]="item.activo ? 'active' : 'inactive'"
                                >
                                  {{ item.activo ? "Activo" : "Inactivo" }}
                                </span>
                              </td>
                            </ng-container>

                            <ng-container matColumnDef="acciones">
                              <th mat-header-cell *matHeaderCellDef>Acciones</th>
                              <td
                                mat-cell
                                *matCellDef="let item"
                                style="
                                  display: flex;
                                  flex-direction: row;
                                  align-items: center;
                                "
                              >
                                <button
                                  mat-icon-button
                                  color="primary"
                                  (click)="editPresentacionCodigo(item)"
                                  matTooltip="Editar"
                                >
                                  <mat-icon>edit</mat-icon>
                                </button>
                                <button
                                  mat-icon-button
                                  color="warn"
                                  (click)="deletePresentacionCodigo(item)"
                                  matTooltip="Eliminar"
                                >
                                  <mat-icon>delete</mat-icon>
                                </button>
                              </td>
                            </ng-container>

                            <tr
                              mat-header-row
                              *matHeaderRowDef="
                                codigosDisplayedColumns;
                                sticky: true
                              "
                            ></tr>
                            <tr
                              mat-row
                              *matRowDef="let row; columns: codigosDisplayedColumns"
                            ></tr>
                          </table>
                        </div>
                      </div>
                      
                      <!-- Receta Section -->
                      <div
                        *ngIf="productoForm.get('isCompuesto')?.value"
                        class="receta-section"
                      >
                        <h4 class="section-title">Receta Asociada</h4>
                        <div class="form-row">
                          <mat-form-field
                            appearance="outline"
                            class="full-width"
                            subscriptSizing="dynamic"
                          >
                            <mat-label>Receta</mat-label>
                            <input
                              type="text"
                              matInput
                              formControlName="recetaSearch"
                              [matAutocomplete]="autoReceta"
                              placeholder="Buscar receta..."
                            />
                            <mat-spinner
                              *ngIf="isLoading"
                              matSuffix
                              diameter="20"
                            ></mat-spinner>
                            <button
                              *ngIf="selectedRecetaModel"
                              matSuffix
                              mat-icon-button
                              type="button"
                              (click)="clearRecetaSelection()"
                            >
                              <mat-icon>clear</mat-icon>
                            </button>
                            <mat-autocomplete
                              #autoReceta="matAutocomplete"
                              [displayWith]="displayRecetaFn"
                              (optionSelected)="onRecetaSelected($event)"
                            >
                              <mat-option
                                *ngFor="let receta of filteredRecetas | async"
                                [value]="receta"
                              >
                                {{ receta.optionText }}
                              </mat-option>
                              <mat-option
                                *ngIf="(filteredRecetas | async)?.length === 0"
                                [disabled]="true"
                              >
                                No se encontraron recetas
                              </mat-option>
                            </mat-autocomplete>
                            <mat-hint
                              >Asocie una receta al producto para cálculos de costos y
                              gestión de inventario</mat-hint
                            >
                          </mat-form-field>
                        </div>

                        <!-- Variation Field (shows when a recipe is selected and has variations) -->
                        <div class="form-row" *ngIf="variaciones.length > 0">
                          <mat-form-field
                            appearance="outline"
                            class="full-width"
                            subscriptSizing="dynamic"
                          >
                            <mat-label>Variación de Receta</mat-label>
                            <mat-select formControlName="variacionId">
                              <mat-option
                                *ngFor="let variacion of variaciones"
                                [value]="variacion.id"
                              >
                                {{ variacion.nombre }}
                                {{ variacion.principal ? "(Principal)" : "" }}
                              </mat-option>
                            </mat-select>
                            <mat-hint
                              >Seleccione la variación específica de la receta para el
                              cálculo de costos</mat-hint
                            >
                          </mat-form-field>
                        </div>

                        <!-- Recipe Cost Information -->
                        <div *ngIf="selectedRecetaModel" class="recipe-cost-info">
                          <div class="cost-card">
                            <div class="cost-details">
                              <div class="cost-item">
                                <span class="cost-label"
                                  >Costo de
                                  {{
                                    variaciones.length > 0 ? "Variación" : "Receta"
                                  }}:</span
                                >
                                <span class="cost-value"
                                  >{{ defaultMonedaSimbolo }}
                                  {{ recipeTotalCost | number : "1.2-2" }}</span
                                >
                              </div>
                              <div class="cost-item suggested-price">
                                <span class="cost-label">Precio Sugerido:</span>
                                <span class="cost-value"
                                  >{{ defaultMonedaSimbolo }}
                                  {{ recipeSuggestedPrice | number : "1.2-2" }}</span
                                >
                                <span class="cost-hint">(Food Cost: 35%)</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </mat-tab>
                </mat-tab-group>
              </div>
              
              <!-- No presentaciones message -->
              <div *ngIf="producto && (!producto.presentaciones || producto.presentaciones.length === 0)" class="empty-list" style="padding: 20px; text-align: center;">
                <mat-icon style="font-size: 48px; width: 48px; height: 48px; color: #ccc; margin-bottom: 16px;">category</mat-icon>
                <p>No hay presentaciones configuradas para este producto</p>
                <button
                  mat-raised-button
                  color="primary"
                  (click)="openPresentacionDialog()"
                >
                  <mat-icon>add</mat-icon>
                  Nueva Presentación
                </button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </mat-card>
</div> 