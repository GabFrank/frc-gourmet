<div class="create-edit-compra-container">
  <div class="loading-shade" *ngIf="isLoading">
    <mat-spinner></mat-spinner>
  </div>

  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>{{ isEditing ? 'Editar' : 'Crear' }} Compra</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="compraForm">
        <div class="section-container">
          <h3 class="section-title">Datos de la Compra</h3>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Proveedor</mat-label>
              <input type="text" matInput formControlName="proveedor" [matAutocomplete]="autoProveedor">
              <mat-autocomplete #autoProveedor="matAutocomplete" [displayWith]="displayProveedor">
                <mat-option *ngFor="let proveedor of filteredProveedores | async" [value]="proveedor.id">
                  {{ proveedor.nombre }} {{ proveedor.ruc ? '- RUC: ' + proveedor.ruc : '' }}
                </mat-option>
              </mat-autocomplete>
              <mat-error *ngIf="compraForm.get('proveedor')?.hasError('required')">
                El proveedor es requerido
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Moneda</mat-label>
              <input type="text" matInput formControlName="moneda" [matAutocomplete]="autoMoneda">
              <mat-autocomplete #autoMoneda="matAutocomplete" [displayWith]="displayMoneda">
                <mat-option *ngFor="let moneda of filteredMonedas | async" [value]="moneda.id">
                  {{ moneda.denominacion }} ({{ moneda.simbolo }})
                </mat-option>
              </mat-autocomplete>
              <mat-error *ngIf="compraForm.get('moneda')?.hasError('required')">
                La moneda es requerida
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Estado</mat-label>
              <input matInput [value]="estadoLabel" readonly>
              <!-- Hidden select to maintain the form control -->
              <select formControlName="estado" hidden>
                <option *ngFor="let option of estadoOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
            </mat-form-field>
          </div>

          <div class="form-row">
            <div class="checkbox-container">
              <mat-checkbox formControlName="isRecepcionMercaderia" color="primary">
                Mercadería Recibida
              </mat-checkbox>
            </div>

            <div class="checkbox-container">
              <mat-checkbox formControlName="activo" color="primary">
                Activo
              </mat-checkbox>
            </div>

            <div class="actions-container">
              <button mat-button type="button" (click)="cancel()">
                Cancelar
              </button>
              <button mat-raised-button color="primary" (click)="saveCompra()" [disabled]="compraForm.invalid || isLoading">
                {{ isEditing ? 'Actualizar' : 'Guardar' }}
              </button>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="section-container" [class.disabled-section]="!canEditDetalles()">
          <h3 class="section-title">Detalles de la Compra</h3>
          <div *ngIf="!canEditDetalles()" class="disabled-message">
            Los detalles de la compra solo pueden ser editados cuando la compra existe y su estado es ABIERTO.
          </div>

          <!-- Form to add new detalles -->
          <div class="detalle-form-container">
            <form [formGroup]="detalleForm" (ngSubmit)="addDetalle()" class="detalle-form">
              <div class="detalle-form-row">
                <mat-form-field appearance="outline" class="search-field">
                  <mat-label>Buscar Producto o Ingrediente</mat-label>
                  <input type="text" matInput formControlName="item" [matAutocomplete]="autoItem">
                  <mat-autocomplete #autoItem="matAutocomplete" [displayWith]="displayItem">
                    <mat-option *ngFor="let item of filteredItems | async" [value]="item">
                      {{ item.nombre }} ({{ item.tipo === 'producto' ? 'Producto' : 'Ingrediente' }})
                    </mat-option>
                  </mat-autocomplete>
                  <mat-error *ngIf="detalleForm.get('item')?.hasError('required')">
                    Debe seleccionar un producto o ingrediente
                  </mat-error>
                </mat-form-field>

                <!-- Show tipo_medida for ingredientes -->
                <mat-form-field appearance="outline" class="tipo-medida-field" *ngIf="detalleForm.get('item')?.value?.tipo === 'ingrediente'">
                  <mat-label>Unidad Base</mat-label>
                  <input matInput [value]="detalleForm.get('item')?.value?.tipo_medida" readonly>
                </mat-form-field>

                <!-- Show unit selector for ingredientes -->
                <mat-form-field appearance="outline" class="unit-selector-field" *ngIf="detalleForm.get('item')?.value?.tipo === 'ingrediente' && availableConversions.length > 0">
                  <mat-label>Unidad</mat-label>
                  <mat-select [formControl]="detalleForm.get('selectedUnit')" required>
                    <mat-option *ngFor="let unit of getCompatibleUnits(detalleForm.get('item')?.value?.tipo_medida)" [value]="unit">
                      {{ unit }}
                    </mat-option>
                  </mat-select>
                  <mat-hint>Unidad de medida para la conversión</mat-hint>
                </mat-form-field>

                <!-- Show presentacion selector for productos -->
                <mat-form-field appearance="outline" class="presentacion-field" *ngIf="detalleForm.get('item')?.value?.tipo === 'producto'">
                  <mat-label>Presentación</mat-label>
                  <input type="text" matInput formControlName="presentacion" [matAutocomplete]="autoPresentacion">
                  <mat-autocomplete #autoPresentacion="matAutocomplete" [displayWith]="displayPresentacion">
                    <mat-option *ngFor="let presentacion of filteredPresentaciones | async" [value]="presentacion">
                      {{ presentacion.descripcion }} ({{ presentacion.cantidad }})
                    </mat-option>
                  </mat-autocomplete>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Cantidad</mat-label>
                  <input type="number" matInput formControlName="cantidad" min="0.01" step="0.01">
                  <mat-hint *ngIf="detalleForm.get('item')?.value?.tipo === 'ingrediente'">
                    En {{ detalleForm.get('selectedUnit')?.value || detalleForm.get('item')?.value?.tipo_medida }}
                  </mat-hint>
                  <mat-error *ngIf="detalleForm.get('cantidad')?.hasError('required')">
                    La cantidad es requerida
                  </mat-error>
                  <mat-error *ngIf="detalleForm.get('cantidad')?.hasError('min')">
                    La cantidad debe ser mayor a 0
                  </mat-error>
                </mat-form-field>

                <!-- Replace valor field with CurrencyInputComponent -->
                <app-currency-input
                  formControlName="valor"
                  label="Valor Unitario"
                  [moneda]="compraForm.get('moneda')?.value ? getMonedaById(compraForm.get('moneda')?.value) : null"
                  [required]="true"
                  [min]="0.01"
                  [hint]="detalleForm.get('item')?.value?.tipo === 'ingrediente' && detalleForm.get('selectedUnit')?.value ? 'Por ' + detalleForm.get('selectedUnit')?.value.toLowerCase() : ''">
                </app-currency-input>

                <!-- Remove Valor convertido field -->

                <!-- Replace total field with CurrencyInputComponent -->
                <app-currency-input
                  [formControl]="totalControl"
                  label="Total Final"
                  [moneda]="compraForm.get('moneda')?.value ? getMonedaById(compraForm.get('moneda')?.value) : null"
                  [disabled]="true"
                  [hint]="detalleForm.get('item')?.value?.tipo === 'ingrediente' && detalleForm.get('selectedUnit')?.value ? detalleForm.get('cantidad')?.value + ' × ' + detalleForm.get('valor')?.value : ''">
                </app-currency-input>

                <button mat-raised-button color="primary" type="submit" class="add-button">
                  <mat-icon>add</mat-icon> Agregar
                </button>
              </div>
            </form>
          </div>

          <!-- Table for detalles -->
          <div class="table-container">
            <table mat-table [dataSource]="detallesWithComputedValues" class="detalles-table">
              <!-- Item Column -->
              <ng-container matColumnDef="item">
                <th mat-header-cell *matHeaderCellDef>Item</th>
                <td mat-cell *matCellDef="let row">{{ row.computedValues.itemName }}</td>
              </ng-container>

              <!-- Tipo Column -->
              <ng-container matColumnDef="tipo">
                <th mat-header-cell *matHeaderCellDef>Tipo</th>
                <td mat-cell *matCellDef="let row">
                  {{ row.control.value.tipo === 'producto' ? 'Producto' : 'Ingrediente' }}
                </td>
              </ng-container>

              <!-- Cantidad Column -->
              <ng-container matColumnDef="cantidad">
                <th mat-header-cell *matHeaderCellDef>Cantidad</th>
                <td mat-cell *matCellDef="let row">{{ row.control.value.cantidad }}</td>
              </ng-container>

              <!-- Valor Column -->
              <ng-container matColumnDef="valor">
                <th mat-header-cell *matHeaderCellDef>Valor Unitario</th>
                <td mat-cell *matCellDef="let row">
                  {{ row.control.value.valor | number:'1.2-2' }}
                  <span class="unit-conversion" *ngIf="row.control.value.unidadMedida" [matTooltip]="row.control.value.unidadMedida">
                    {{ row.control.value.tipo_medida }}
                    <mat-icon class="conversion-icon">swap_horiz</mat-icon>
                  </span>
                </td>
              </ng-container>

              <!-- Subtotal Column -->
              <ng-container matColumnDef="subtotal">
                <th mat-header-cell *matHeaderCellDef>Subtotal</th>
                <td mat-cell *matCellDef="let row">
                  {{ row.computedValues.subtotal | number:'1.2-2' }}
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="acciones">
                <th mat-header-cell *matHeaderCellDef>Acciones</th>
                <td mat-cell *matCellDef="let row; let i = index">
                  <button mat-icon-button color="warn" (click)="removeDetalle(i)" matTooltip="Eliminar" [disabled]="!detallesActionsEnabled">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

              <!-- No data row -->
              <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell" [attr.colspan]="displayedColumns.length" style="text-align: center; padding: 16px;">
                  No hay detalles agregados a la compra.
                </td>
              </tr>
            </table>

            <!-- Update total container to use currency formatting -->
            <div class="total-container">
              <span class="total-label">Total:</span>
              <span class="total-value">{{ compraForm.get('total')?.value | number:'1.2-2' }}</span>
            </div>
          </div>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
